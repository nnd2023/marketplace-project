## UC-015 Комплектация заказа

| Поле                | Значение                        |
|---------------------|---------------------------------|
| **ID**              | UC-015                          |
| **Название**        | Комплектация заказа             |
| **Требования**      | FR-128: Генерация листа комплектации; FR-129: Маркировка посылки |
| **Элемент Бэклога** |                                 |
| **Сервис**          | warehouse-service               |
| **Статус**          | ЧЕРНОВИК                        |
| **Описание**        | Сценарий описывает процесс комплектации заказа оператором склада: от получения задания до маркировки готовой посылки. <br>Интегрируется с:<br>	UC-016 Передача курьеру |
| **Участники**       | ROLE_WAREHOUSE_OPERATOR (Оператор склада) |
| **Триггер**         | Заказ получает статус «Готов к комплектации» в системе или оператор вручную выбирает заказ из списка ожидающих комплектацию. |
| **Предусловия**     | 1. Оператор авторизован в системе управления складом (WMS).<br>2. Заказ находится в статусе «Готов к комплектации».<br>3. Все товары заказа зарезервированы в инвентаре.<br>4. Сервис `warehouse-service` доступен.<br>5. На складе доступны необходимые упаковочные материалы и принтер этикеток. |
| **Постусловия**     | - **Успешное завершение:** Заказ переведён в статус «Скомплектован», сгенерирована этикетка с трек-номером, лист комплектации заархивирован.<br>- **Альтернативное завершение:** Комплектация приостановлена (недостача/повреждение товара), заказ переведён в статус «Требует внимания».<br>- **Исключительное завершение:** Ошибка системы; заказ остаётся в исходном статусе, изменения откатываются. |
| **Успешный сценарий** | 1. Оператор открывает терминал/планшет складского работника и переходит в раздел «Заказы на комплектацию». Система отображает список заказов со статусом «Готов к комплектации», отсортированный по приоритету (срочность доставки).<br>2. Оператор выбирает заказ для комплектации. Система отправляет запрос к `warehouse-service`: GET /api/v1/warehouse/orders/{orderId}/picking-list<br>3. `warehouse-service` генерирует лист комплектации (маппинг: **FR-128**) и возвращает HTTP 200 + JSON со структурой:<br>   - Заголовок заказа (номер, дата, адрес доставки)<br>   - Список товаров с указанием:<br>     • SKU и название товара<br>     • Требуемое количество<br>     • Локация хранения (стеллаж, полка, ячейка)<br>     • QR-код ячейки для сканирования<br>   - Рекомендованный маршрут по складу<br>   - Штрихкод заказа для идентификации<br>4. Система отображает лист комплектации на экране терминала и предлагает:<br>   - «Распечатать лист» (на складском принтере)<br>   - «Начать комплектацию» (переход в режим сканирования)<br>5. Оператор нажимает «Начать комплектацию». Система переводит заказ в статус «В процессе комплектации» и открывает интерфейс сканирования.<br>6. Оператор сканирует QR-код первой ячейки хранения из листа комплектации. Система подтверждает сканирование звуковым сигналом и отображает:<br>   - Название товара в ячейке<br>   - Требуемое количество для текущего заказа<br>   - Поле для ввода/сканирования количества фактически взятого товара<br>7. Оператор сканирует штрихкод товара (или вводит количество вручную) и подтверждает. Система:<br>   - Проверяет соответствие товара и количества требованиям заказа<br>   - Обновляет прогресс комплектации в реальном времени («Собрано 2 из 5 товаров»)<br>   - Отмечает ячейку как обработанную в листе комплектации<br>8. Оператор повторяет шаги 6-7 для всех товаров в заказе.<br>9. После сборки всех товаров система отображает подтверждение: *«Комплектация завершена. Подготовьте посылку к маркировке»*.<br>10. Оператор упаковывает товары в коробку/пакет и нажимает кнопку «Маркировать посылку».<br>11. Система отправляет запрос к `warehouse-service`: POST /api/v1/warehouse/orders/{orderId}/label с параметрами упаковки (габариты, вес).<br>12. `warehouse-service`:<br>    - Генерирует уникальный трек-номер (интеграция с логистическим провайдером)<br>    - Формирует шаблон этикетки с данными:<br>      • Трек-номер и штрихкод посылки (маппинг: **FR-129**)<br>      • Адрес получателя<br>      • Список товаров в посылке<br>      • QR-код для сканирования при передаче курьеру<br>    - Возвращает HTTP 201 + данные этикетки и бинарный файл изображения этикетки (PDF/PNG)<br>13. Система автоматически отправляет команду на печать этикетки на подключенный принтер.<br>14. Оператор наклеивает распечатанную этикетку на посылку и сканирует штрихкод трек-номера для подтверждения.<br>15. Система:<br>    - Переводит заказ в статус «Скомплектован»<br>    - Фиксирует время завершения комплектации и идентификатор оператора в аудит-логе (маппинг: **FR-128**, **FR-129**)<br>    - Отображает уведомление: *«Заказ {номер} успешно скомплектован. Передайте посылку на пункт отправки»*<br>16. Оператор перемещает посылку в зону готовых к отправке заказов. Процесс завершён. |
| **Альтернативный сценарий АС1** | На шаге 7 успешного сценария оператор обнаруживает недостачу товара в ячейке (требуется 3 шт, доступно 1 шт).<br>Оператор нажимает кнопку «Проблема с товаром» в интерфейсе.<br>Система открывает форму выбора причины:<br> - «Недостача на складе»<br> - «Повреждённый товар»<br> - «Некорректное размещение»<br>Оператор выбирает причину и указывает фактическое количество.<br>Система:<br> - Блокирует дальнейшую комплектацию заказа<br> - Переводит заказ в статус «Требует внимания»<br> - Создаёт задачу для старшего оператора/инвентаризатора с уведомлением<br> - Сохраняет информацию о проблеме в лог заказа<br>Оператор может продолжить комплектацию других заказов. |
| **Альтернативный сценарий АС2** | На шаге 14 успешного сценария оператор обнаруживает повреждение упаковки/товара после комплектации.<br>Оператор нажимает «Отменить маркировку» до сканирования трек-номера.<br>Система:<br> - Отменяет генерацию этикетки<br> - Возвращает заказ в статус «В процессе комплектации»<br> - Предлагает варианты:<br>   • «Заменить товар» — переход к поиску аналогичного товара в инвентаре<br>   • «Отменить заказ» — инициировать процесс отмены с уведомлением покупателя<br>Оператор выбирает действие и продолжает работу. |
| **Альтернативный сценарий АС3** | Оператор ошибочно выбрал не тот заказ или начал комплектацию не своей зоны ответственности.<br>На любом этапе до шага 14 оператор нажимает «Прервать комплектацию».<br>Система запрашивает подтверждение: *«Прервать комплектацию заказа {номер}? Собранные товары будут возвращены в резерв»*.<br>После подтверждения:<br> - Система отменяет резервирование товаров через `inventory-service`<br> - Переводит заказ обратно в статус «Готов к комплектации»<br> - Очищает прогресс комплектации для данного оператора<br> - Отображает уведомление: *«Комплектация прервана»* |
| **Сценарий исключений СИ1** | На шаге 3 или 12 успешного сценария `warehouse-service` возвращает HTTP 5xx или таймаут > 5с.<br>Система:<br> - Логирует ошибку (уровень ERROR) с traceID, orderId и идентификатором оператора<br> - Отображает пользователю: *«Ошибка сервиса склада. Повторите попытку через 30 секунд»*<br> - Предлагает кнопки:<br>   • «Повторить» — повторная отправка запроса<br>   • «Перейти к другому заказу» — временный переход без потери прогресса текущего заказа (если применимо)<br>Если ошибка повторяется 3 раза подряд — заказ автоматически переводится в статус «Требует технического вмешательства». |
| **Сценарий исключений СИ2** | На шаге 12 успешного сценария логистический провайдер недоступен и не может сгенерировать трек-номер.<br>`warehouse-service` возвращает ошибку интеграции с кодом 424 (Failed Dependency).<br>Система:<br> - Логирует ошибку (уровень WARN)<br> - Предлагает оператору:<br>   • «Использовать резервный провайдер» — автоматический переход к альтернативному логистическому сервису<br>   • «Сгенерировать временный трек-номер» — локальная генерация с последующей синхронизацией при восстановлении связи (требует подтверждения старшего оператора)<br> - Если оба варианта недоступны — отображает: *«Невозможно сгенерировать этикетку. Обратитесь к руководителю смены»* и блокирует завершение комплектации. |
