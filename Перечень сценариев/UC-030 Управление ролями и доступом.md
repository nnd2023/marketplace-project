## UC-030 Управление ролями и доступом

| Поле                | Значение                        |
|---------------------|---------------------------------|
| **ID**              | UC-030                          |
| **Название**        | Управление ролями и доступом    |
| **Требования**      | FR-158: RBAC с 14+ ролями; FR-159: Аудит изменений прав |
| **Элемент Бэклога** |                                 |
| **Сервис**          | auth-service; iam-service       |
| **Статус**          | ЧЕРНОВИК                        |
| **Описание**        | Сценарий описывает процесс управления ролями и правами доступа администраторами маркетплейса и системы. Включает создание/редактирование ролей, назначение ролей пользователям, настройку иерархии прав и просмотр аудита изменений.<br>Интегрируется с:<br>UC-009 Регистрация продавца<br>UC-032 Аудит операций |
| **Участники**       | ROLE_MARKETPLACE_ADMIN (Администратор маркетплейса); ROLE_SYSTEM_ADMIN (Системный администратор) |
| **Триггер**         | Администратор открывает раздел «Управление доступом» в админ-панели или получает запрос на изменение прав пользователя. |
| **Предусловия**     | 1. Администратор авторизован в системе с соответствующими правами.<br>2. ROLE_SYSTEM_ADMIN имеет полный доступ ко всем функциям сценария.<br>3. ROLE_MARKETPLACE_ADMIN имеет доступ только к управлению бизнес-ролями (не системными).<br>4. Сервисы `auth-service` и `iam-service` доступны.<br>5. В системе существует как минимум одна предопределённая роль (базовый набор из 14 ролей загружен при инициализации). |
| **Постусловия**     | - **Успешное завершение:** Роль создана/изменена или права пользователя обновлены; изменения зафиксированы в аудит-логе.<br>- **Альтернативное завершение:** Изменения отменены администратором; система возвращена в исходное состояние.<br>- **Исключительное завершение:** Ошибка валидации или система; изменения не применены, отображено сообщение об ошибке. |
| **Успешный сценарий** | 1. Администратор открывает раздел «Управление доступом» → «Роли и права» в админ-панели. Система отправляет запрос к `iam-service`: GET /api/v1/iam/roles?includePermissions=true<br>2. `iam-service` возвращает HTTP 200 + список всех ролей системы (минимум 14 предопределённых):<br>   - Бизнес-роли: ROLE_CUSTOMER, ROLE_SELLER, ROLE_SELLER_ADMIN, ROLE_WAREHOUSE_OPERATOR, ROLE_SUPPORT_AGENT, ROLE_COURIER, ROLE_MARKETPLACE_ADMIN, ROLE_MODERATOR, ROLE_CATEGORY_MANAGER<br>   - Системные роли: ROLE_SYSTEM_ADMIN, ROLE_AUDITOR<br>   Для каждой роли отображаются:<br>   - Название и описание<br>   - Тип (бизнес/системная)<br>   - Список разрешений (например: `catalog:read`, `catalog:write`, `order:manage`, `user:impersonate`)<br>   - Количество пользователей с данной ролью<br>3. Администратор выбирает действие:<br>   **Вариант А — Назначение роли пользователю:**<br>   - Нажимает «Назначить роль» → вводит email/ID пользователя или выбирает из списка<br>   - Система отображает текущие роли пользователя и список доступных ролей для назначения<br>   - Администратор выбирает роль и подтверждает (кнопка «Назначить»)<br>   - Система отправляет запрос к `iam-service`: POST /api/v1/iam/users/{userId}/roles с телом { "roleId": "ROLE_SELLER", "grantedBy": "admin_id" }<br>   - `iam-service` валидирует запрос (проверка конфликтов ролей, ограничений иерархии) и возвращает HTTP 201<br>   - Система отображает уведомление: *«Роль ROLE_SELLER успешно назначена пользователю {email}»* (маппинг: **FR-158**)<br>   **Вариант Б — Создание кастомной роли (только ROLE_SYSTEM_ADMIN):**<br>   - Нажимает «Создать роль» → вводит название, описание, тип роли<br>   - В интерфейсе «Конструктор прав» выбирает разрешения из иерархического списка (группы: Каталог, Заказы, Пользователи, Финансы, Склад, Аналитика)<br>   - Настраивает ограничения (например: «Доступ только к своим товарам» для продавцов)<br>   - Подтверждает создание (кнопка «Сохранить роль»)<br>   - Система отправляет запрос к `iam-service`: POST /api/v1/iam/roles с полной спецификацией роли в формате JSON<br>   - `iam-service` валидирует уникальность названия и корректность прав, сохраняет роль и возвращает HTTP 201 + данные новой роли<br>   - Система отображает уведомление: *«Роль {название} успешно создана»* (маппинг: **FR-158**)<br>4. Система автоматически фиксирует событие в аудит-лог через `auth-service` (маппинг: **FR-159**):<br>   - Тип события: `ROLE_ASSIGNMENT_CREATED` / `ROLE_CREATED`<br>   - Инициатор: идентификатор и роль администратора<br>   - Целевой объект: ID пользователя или роли<br>   - Старое значение / Новое значение<br>   - IP-адрес и временная метка операции<br>5. Администратор может просмотреть историю изменений в любой момент через раздел «Аудит доступа» с фильтрацией по типу события, пользователю, периоду. |
| **Альтернативный сценарий АС1** | На шаге 3 (Вариант А) администратор пытается назначить конфликтующие роли (например, ROLE_SELLER и ROLE_CUSTOMER одновременно для одного аккаунта).<br>Система валидирует запрос на стороне клиента и сервера.<br>Отображает предупреждение:<br> *«Невозможно назначить роль ROLE_SELLER: пользователь уже имеет конфликтующую роль ROLE_CUSTOMER»*<br>Предлагает варианты:<br> - «Отозвать роль ROLE_CUSTOMER и назначить ROLE_SELLER» (требует подтверждения)<br> - «Отменить операцию»<br>Администратор выбирает действие и продолжает работу. |
| **Альтернативный сценарий АС2** | На шаге 3 (Вариант Б) администратор с ролью ROLE_MARKETPLACE_ADMIN пытается создать системную роль или изменить предопределённую системную роль.<br>Система проверяет права администратора перед отображением интерфейса.<br>Отображает уведомление:<br> *«У вас недостаточно прав для управления системными ролями. Обратитесь к системному администратору»*<br>Интерфейс создания/редактирования системных ролей скрыт или недоступен для данной роли. |
| **Альтернативный сценарий АС3** | Администратор начинает операцию назначения роли, но перед подтверждением решает отменить изменения.<br>На любом этапе до отправки запроса к `iam-service` администратор нажимает «Отмена» или «Назад».<br>Система закрывает форму без отправки запросов.<br>Отображает уведомление: *«Изменения отменены»*.<br>Состояние ролей пользователей остаётся без изменений. |
| **Сценарий исключений СИ1** | На шаге 3 при отправке запроса к `iam-service` сервис возвращает ошибку валидации HTTP 400:<br> - Попытка назначить роль пользователю, который не прошёл верификацию<br> - Нарушение бизнес-правила (например, назначение ROLE_WAREHOUSE_MANAGER без предварительного назначения ROLE_WAREHOUSE_OPERATOR)<br> - Превышение лимита ролей на пользователя (максимум 5 бизнес-ролей)<br>Система отображает детальное сообщение об ошибке:<br> *«Не удалось назначить роль: {причина из ответа сервиса}»*<br>Администратор может исправить параметры и повторить операцию. |
| **Сценарий исключений СИ2** | `iam-service` или `auth-service` возвращает HTTP 5xx или таймаут > 3с при попытке сохранения изменений.<br>Система:<br> - Логирует ошибку (уровень ERROR) с traceID и деталями операции<br> - Отображает пользователю:<br>   *«Ошибка при сохранении изменений. Повторите попытку или обратитесь в техподдержку»*<br> - Предлагает кнопку «Повторить»<br> - Гарантирует отсутствие частичного применения изменений (транзакционность операции)<br>Если ошибка сохраняется после 3 попыток — блокирует дальнейшие операции с отображением уведомления для технической поддержки. |
| **Сценарий исключений СИ3** | При попытке отзыва последней активной роли у администратора (включая собственную роль).<br>Система обнаруживает попытку самоблокировки или нарушения принципа разделения обязанностей.<br>Отображает предупреждение:<br> *«Невозможно отозвать роль {название}: это приведёт к потере доступа к системе управления»*<br>Операция блокируется. Для отзыва роли требуется подтверждение второго администратора с равными или высшими правами (двухфакторное подтверждение для критических операций). |



## UC-030 Управление ролями и доступом

| Поле                | Значение                        |
|---------------------|---------------------------------|
| **ID**              | UC-030                          |
| **Название**        | Управление ролями и доступом    |
| **Требования**      | FR-158: RBAC с 14+ ролями; FR-159: Аудит изменений прав |
| **Элемент Бэклога** |                                 |
| **Сервис**          | auth-service; iam-service       |
| **Статус**          | ЧЕРНОВИК                        |
| **Описание**        | Сценарий описывает процесс управления ролями, разрешениями и назначением прав доступа администраторами маркетплейса. Реализует модель RBAC (Role-Based Access Control) с поддержкой 14+ предопределённых ролей и гибкой настройкой разрешений.<br>Интегрируется с:<br>UC-031 Управление пользователями<br>UC-035 Просмотр аудит-логов безопасности |
| **Участники**       | ROLE_MARKETPLACE_ADMIN (Администратор маркетплейса); ROLE_SYSTEM_ADMIN (Системный администратор) |
| **Триггер**         | Администратор открывает раздел «Управление доступом» в админ-панели или получает запрос на изменение прав доступа для пользователя/роли. |
| **Предусловия**     | 1. Администратор авторизован в системе с ролью `ROLE_MARKETPLACE_ADMIN` или `ROLE_SYSTEM_ADMIN`.<br>2. Сервисы `auth-service` и `iam-service` доступны.<br>3. Сессия администратора прошла дополнительную верификацию (требуется MFA для операций с правами).<br>4. Для `ROLE_MARKETPLACE_ADMIN` доступны только бизнес-роли; системные роли доступны только `ROLE_SYSTEM_ADMIN`. |
| **Постусловия**     | - **Успешное завершение:** Роль создана/изменена/назначена; изменения зафиксированы в аудит-логе.<br>- **Альтернативное завершение:** Изменения отменены администратором; система осталась в исходном состоянии.<br>- **Исключительное завершение:** Ошибка валидации или система защиты; изменения отклонены, администратор уведомлён. |
| **Успешный сценарий** | 1. Администратор открывает раздел «Управление доступом» → «Роли и разрешения» в админ-панели. Система проверяет права доступа к разделу и запрашивает подтверждение MFA (если не выполнено в текущей сессии).<br>2. Система отображает интерфейс с тремя вкладками:<br>   - «Список ролей» (предопределённые и кастомные)<br>   - «Назначение ролей пользователям»<br>   - «Аудит изменений»<br>3. **Сценарий А (Просмотр и анализ ролей):**<br>   - Администратор выбирает вкладку «Список ролей».<br>   - Система отправляет запрос к `iam-service`: GET /api/v1/iam/roles?includePermissions=true<br>   - `iam-service` возвращает HTTP 200 + массив из 14+ предопределённых ролей (маппинг: **FR-158**), например:<br>     • ROLE_CUSTOMER, ROLE_SELLER, ROLE_WAREHOUSE_OPERATOR<br>     • ROLE_MARKETPLACE_ADMIN, ROLE_SYSTEM_ADMIN<br>     • ROLE_SUPPORT_AGENT, ROLE_ANALYST и др.<br>   - Для каждой роли отображается:<br>     • Название и описание назначения<br>     • Список разрешений (ресурсы + операции: CREATE/READ/UPDATE/DELETE)<br>     • Количество пользователей с данной ролью<br>     • Флаг «Системная роль» (только для `ROLE_SYSTEM_ADMIN`)<br>4. **Сценарий Б (Создание кастомной роли):**<br>   - Администратор нажимает «Создать роль».<br>   - Система открывает форму с полями:<br>     • Название роли (уникальное, префикс `CUSTOM_`)<br>     • Описание назначения<br>     • Выбор базовой роли (опционально, для наследования разрешений)<br>     • Матрица разрешений: таблица «Ресурс ↔ Операции» с чекбоксами<br>   - Администратор заполняет форму и нажимает «Проверить конфликты».<br>   - Система отправляет запрос к `iam-service`: POST /api/v1/iam/roles/validate с телом роли.<br>   - `iam-service` проверяет:<br>     • Отсутствие конфликта с принципом разделения обязанностей (SoD)<br>     • Соблюдение минимальных привилегий<br>     • Отсутствие циклических зависимостей при наследовании<br>   - При успешной валидации администратор нажимает «Создать роль».<br>   - Система отправляет запрос: POST /api/v1/iam/roles<br>   - `iam-service` создаёт роль и возвращает HTTP 201 + данные новой роли.<br>   - Система отображает уведомление: *«Роль успешно создана»*.<br>5. **Сценарий В (Назначение роли пользователю):**<br>   - Администратор переходит на вкладку «Назначение ролей» и ищет пользователя по email/ID.<br>   - Система отображает текущие роли пользователя и кнопку «Назначить роль».<br>   - Администратор выбирает роль из списка (фильтрация по доступным ролям для его уровня доступа).<br>   - Для критических ролей (например, `ROLE_SYSTEM_ADMIN`) система запрашивает двухфакторное подтверждение:<br>     • Ввод кода из SMS/email<br>     • Подтверждение вторым администратором (эскалация)<br>   - Администратор подтверждает назначение.<br>   - Система отправляет запрос к `iam-service`: POST /api/v1/iam/users/{userId}/roles с телом { "roleId": "..." }<br>   - `iam-service` проверяет:<br>     • Пользователь не потеряет все роли (защита от самоблокировки при редактировании)<br>     • Нет конфликта ролей (например, одновременно `ROLE_SELLER` и `ROLE_WAREHOUSE_OPERATOR` для одного пользователя)<br>   - При успехе система:<br>     • Назначает роль пользователю<br>     • Фиксирует событие в аудит-логе (маппинг: **FR-159**)<br>     • Отправляет уведомление пользователю о новом доступе (если настроено)<br>     • Отображает уведомление: *«Роль назначена пользователю {email}»*<br>6. **Сценарий Г (Аудит изменений):**<br>   - Администратор переходит на вкладку «Аудит изменений».<br>   - Система отображает фильтруемый журнал событий с полями:<br>     • Дата/время события<br>     • Инициатор (администратор + роль)<br>     • Тип операции (создание/изменение/удаление роли, назначение/отзыв роли)<br>     • Объект изменения (роль или пользователь)<br>     • Старые и новые значения разрешений<br>     • IP-адрес и устройство инициатора<br>   - Все записи неизменяемы и защищены от удаления (маппинг: **FR-159**). |
| **Альтернативный сценарий АС1** | При создании/редактировании роли система обнаруживает конфликт с принципом разделения обязанностей (например, роль получает права на создание заказов И отмену платежей).<br>Система блокирует сохранение и отображает:<br> *«Обнаружен конфликт прав: {описание конфликта}»*<br> *«Рекомендуется разделить на две отдельные роли»*<br>Администратор может:<br> - Исправить набор разрешений<br> - Запросить исключение (требует подтверждения `ROLE_SYSTEM_ADMIN`)<br>После устранения конфликта операция продолжается. |
| **Альтернативный сценарий АС2** | Администратор пытается отозвать у себя последнюю роль, дающую доступ к разделу управления доступом.<br>Система обнаруживает попытку самоблокировки на этапе валидации.<br>Отображает предупреждение:<br> *«Вы пытаетесь отозвать у себя последнюю роль с доступом к управлению правами. Это заблокирует ваш доступ к системе»*<br>Предлагает варианты:<br> - «Назначить себе другую роль с доступом перед отзывом»<br> - «Отменить операцию»<br>Операция блокируется до разрешения ситуации. |
| **Альтернативный сценарий АС3** | `ROLE_MARKETPLACE_ADMIN` пытается изменить системную роль (например, `ROLE_SYSTEM_ADMIN`).<br>Система проверяет права на этапе запроса к `iam-service`.<br>`iam-service` возвращает HTTP 403 Forbidden.<br>Система отображает:<br> *«У вас недостаточно прав для изменения системных ролей. Обратитесь к системному администратору»*<br>Интерфейс скрывает кнопки редактирования для недоступных ролей. |
| **Сценарий исключений СИ1** | При назначении роли пользователю `iam-service` обнаруживает, что у пользователя уже есть конфликтующая роль (например, одновременно продавец и складской оператор для одного аккаунта).<br>Сервис возвращает HTTP 409 Conflict с деталями конфликта.<br>Система отображает:<br> *«Невозможно назначить роль: конфликт с существующей ролью {conflictingRole}»*<br> *«Причина: {описание бизнес-правила}»*<br>Предлагает:<br> - «Отозвать конфликтующую роль и продолжить» (с подтверждением)<br> - «Отменить операцию» |
| **Сценарий исключений СИ2** | При сохранении изменений роли `iam-service` недоступен (HTTP 5xx / таймаут).<br>Система:<br> - Логирует ошибку (уровень CRITICAL) с полным состоянием формы и идентификатором администратора<br> - Отображает: *«Системная ошибка при сохранении роли. Изменения не применены»*<br> - Предлагает:<br>   • «Повторить попытку» (повторная отправка с теми же данными)<br>   • «Сохранить черновик локально» (экспорт JSON конфигурации роли)<br>   • «Отменить и выйти»<br> - Блокирует навигацию с предупреждением о несохранённых изменениях |
| **Сценарий исключений СИ3** | При двухфакторном подтверждении критической операции (назначение `ROLE_SYSTEM_ADMIN`) истекает время ожидания кода подтверждения (> 5 минут).<br>Система автоматически отменяет операцию.<br>Отображает:<br> *«Время ожидания подтверждения истекло. Операция отменена в целях безопасности»*<br>Форма сброса состояния; требуется повторный выбор пользователя и роли. |
